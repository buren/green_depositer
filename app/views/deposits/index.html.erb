<%- model_class = Deposit -%>
<div class="page-header">
  <h1><%=t '.title', :default => model_class.model_name.human.pluralize.titleize %></h1>
</div>

<div class="col-sm-12">
  <div id="map"></div>
</div>

<div class="col-sm-6">
  <h3>Deposits by category</h3>
  <%= pie_chart deposits_by_category_chart_path, refresh: 500 %>
</div>

<div class="col-sm-6">
  <h3>Deposits by day</h3>
  <%= line_chart deposits_by_day_chart_path, refresh: 500 %>
</div>

<table class="table table-striped">
  <thead>
    <tr>
      <th><%= model_class.human_attribute_name(:id) %></th>
      <th><%= model_class.human_attribute_name(:quantity) %></th>
      <th><%= model_class.human_attribute_name(:unit) %></th>
      <th><%= model_class.human_attribute_name(:category) %></th>
      <th><%= model_class.human_attribute_name(:latitude) %></th>
      <th><%= model_class.human_attribute_name(:longitude) %></th>
      <th><%= model_class.human_attribute_name(:created_at) %></th>
      <th><%=t '.actions', :default => t("helpers.actions") %></th>
    </tr>
  </thead>
  <tbody>
    <% @deposits.each do |deposit| %>
      <tr>
        <td><%= link_to deposit.id, deposit_path(deposit) %></td>
        <td><%= deposit.quantity %></td>
        <td><%= deposit.unit %></td>
        <td><%= deposit.category %></td>
        <td><%= deposit.latitude %></td>
        <td><%= deposit.longitude %></td>
        <td><%= l(deposit.created_at)[0..16] %></td>
        <td>
          <%= link_to t('.edit', :default => t("helpers.links.edit")),
                      edit_deposit_path(deposit), :class => 'btn btn-default btn-xs' %>
          <%= link_to t('.destroy', :default => t("helpers.links.destroy")),
                      deposit_path(deposit),
                      :method => :delete,
                      :data => { :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?')) },
                      :class => 'btn btn-xs btn-danger' %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<%= link_to t('.new', :default => t("helpers.links.new")),
            new_deposit_path,
            :class => 'btn btn-primary' %>

<script type="text/javascript">
  function buildMapFromLatLongs(latLongs) {
    var centerPos = {lat: 59.329485, lng: 18.043327};

    var options = {
      'zoom': 12,
      'center': centerPos,
      'mapTypeId': google.maps.MapTypeId.ROADMAP
    };

    var map = new google.maps.Map(document.getElementById('map'), options);

    var markers = [];
    for (var i = 0; i < latLongs.length; i++) {
      var latLng = new google.maps.LatLng(latLongs[i][0], latLongs[i][1]);
      var marker = new google.maps.Marker({position: latLng});
      markers.push(marker);
    }
    var markerCluster = new MarkerClusterer(map, markers);
  }

  function initMap() {
    $.getJSON('/deposits/lat_longs', function(latLongs) {
      buildMapFromLatLongs(latLongs);
    });
  }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?signed_in=false&callback=initMap"></script>
